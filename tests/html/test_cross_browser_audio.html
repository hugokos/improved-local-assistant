<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Browser Audio Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
            min-width: 120px;
        }
        .test-button:hover { background: #005a9e; }
        .test-button:disabled { background: #ccc; cursor: not-allowed; }
        .test-button.success { background: #28a745; }
        .test-button.error { background: #dc3545; }
        
        .status {
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.warning { background: #fff3cd; color: #856404; }
        
        .browser-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 4px;
        }
        .browser-edge { background: #0078d4; color: white; }
        .browser-chrome { background: #4285f4; color: white; }
        .browser-firefox { background: #ff9500; color: white; }
        .browser-safari { background: #000; color: white; }
        
        .log-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .compatibility-matrix {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .compatibility-matrix th,
        .compatibility-matrix td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: center;
        }
        .compatibility-matrix th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .compat-pass { background: #d4edda; color: #155724; }
        .compat-fail { background: #f8d7da; color: #721c24; }
        .compat-unknown { background: #e2e3e5; color: #6c757d; }
    </style>
</head>
<body>
    <h1>üîß Cross-Browser Audio Compatibility Test</h1>
    
    <div class="test-card">
        <h3>üåê Browser Detection</h3>
        <div id="browserInfo">Detecting...</div>
        <div id="browserBadges"></div>
    </div>

    <div class="test-grid">
        <div class="test-card">
            <h3>üîä Speaker Tests</h3>
            <button class="test-button" onclick="testWebAudioSpeaker()">WebAudio Test</button>
            <button class="test-button" onclick="testHTML5Audio()">HTML5 Audio</button>
            <button class="test-button" onclick="testTTSSimulation()">TTS Simulation</button>
            <div id="speakerStatus" class="status info">Ready to test speakers</div>
        </div>

        <div class="test-card">
            <h3>üé§ Microphone Tests</h3>
            <button class="test-button" onclick="testMicrophoneAccess()">Access Test</button>
            <button class="test-button" onclick="testMicrophoneLevel()" id="micLevelBtn">Level Test</button>
            <button class="test-button" onclick="stopMicTest()" disabled id="stopMicBtn">Stop</button>
            <div id="micStatus" class="status info">Ready to test microphone</div>
        </div>

        <div class="test-card">
            <h3>‚ö° Performance Tests</h3>
            <button class="test-button" onclick="testAudioLatency()">Latency Test</button>
            <button class="test-button" onclick="testChunkProcessing()">Chunk Processing</button>
            <button class="test-button" onclick="testMemoryUsage()">Memory Test</button>
            <div id="performanceStatus" class="status info">Ready for performance tests</div>
        </div>

        <div class="test-card">
            <h3>üîÑ Integration Tests</h3>
            <button class="test-button" onclick="testFullVoiceFlow()">Full Voice Flow</button>
            <button class="test-button" onclick="testErrorRecovery()">Error Recovery</button>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <div id="integrationStatus" class="status info">Ready for integration tests</div>
        </div>
    </div>

    <div class="test-card">
        <h3>üìä Test Results</h3>
        <table class="compatibility-matrix">
            <thead>
                <tr>
                    <th>Test</th>
                    <th>Edge</th>
                    <th>Chrome</th>
                    <th>Firefox</th>
                    <th>Safari</th>
                </tr>
            </thead>
            <tbody id="resultsMatrix">
                <tr>
                    <td>WebAudio Support</td>
                    <td class="compat-unknown" id="webAudioEdge">?</td>
                    <td class="compat-unknown" id="webAudioChrome">?</td>
                    <td class="compat-unknown" id="webAudioFirefox">?</td>
                    <td class="compat-unknown" id="webAudioSafari">?</td>
                </tr>
                <tr>
                    <td>Microphone Access</td>
                    <td class="compat-unknown" id="micEdge">?</td>
                    <td class="compat-unknown" id="micChrome">?</td>
                    <td class="compat-unknown" id="micFirefox">?</td>
                    <td class="compat-unknown" id="micSafari">?</td>
                </tr>
                <tr>
                    <td>TTS Playback</td>
                    <td class="compat-unknown" id="ttsEdge">?</td>
                    <td class="compat-unknown" id="ttsChrome">?</td>
                    <td class="compat-unknown" id="ttsFirefox">?</td>
                    <td class="compat-unknown" id="ttsSafari">?</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-card">
        <h3>üìù Test Log</h3>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
        <button class="test-button" onclick="exportResults()">Export Results</button>
        <div id="testLog" class="log-container"></div>
    </div>

    <script>
        let testResults = {};
        let currentBrowser = '';
        let micStream = null;
        let testAudioContext = null;

        // Logging
        function log(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('testLog');
            const entry = `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            logEl.textContent += entry;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`üîç ${entry.trim()}`);
        }

        function clearLog() {
            document.getElementById('testLog').textContent = '';
        }

        // Browser detection
        function detectBrowser() {
            const ua = navigator.userAgent;
            const browsers = {
                edge: /Edg/.test(ua),
                chrome: /Chrome/.test(ua) && !/Edg/.test(ua),
                firefox: /Firefox/.test(ua),
                safari: /Safari/.test(ua) && !/Chrome/.test(ua)
            };

            currentBrowser = Object.keys(browsers).find(b => browsers[b]) || 'unknown';
            
            const info = {
                browser: currentBrowser,
                userAgent: ua,
                hasAudioContext: !!(window.AudioContext || window.webkitAudioContext),
                hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                isSecureContext: window.isSecureContext,
                protocol: window.location.protocol
            };

            document.getElementById('browserInfo').innerHTML = `
                <strong>Browser:</strong> ${currentBrowser.charAt(0).toUpperCase() + currentBrowser.slice(1)}<br>
                <strong>AudioContext:</strong> ${info.hasAudioContext ? '‚úÖ' : '‚ùå'}<br>
                <strong>getUserMedia:</strong> ${info.hasGetUserMedia ? '‚úÖ' : '‚ùå'}<br>
                <strong>Secure Context:</strong> ${info.isSecureContext ? '‚úÖ' : '‚ùå'}
            `;

            const badgesEl = document.getElementById('browserBadges');
            badgesEl.innerHTML = `<span class="browser-badge browser-${currentBrowser}">${currentBrowser.toUpperCase()}</span>`;

            log(`Browser detected: ${currentBrowser}`);
            return info;
        }

        // Update test result in matrix
        function updateResult(test, browser, passed) {
            const cellId = `${test}${browser.charAt(0).toUpperCase() + browser.slice(1)}`;
            const cell = document.getElementById(cellId);
            if (cell) {
                cell.className = passed ? 'compat-pass' : 'compat-fail';
                cell.textContent = passed ? '‚úÖ' : '‚ùå';
            }
            
            if (!testResults[test]) testResults[test] = {};
            testResults[test][browser] = passed;
        }

        // WebAudio speaker test
        async function testWebAudioSpeaker() {
            const statusEl = document.getElementById('speakerStatus');
            statusEl.textContent = 'Testing WebAudio...';
            statusEl.className = 'status info';

            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                testAudioContext = new AudioContextClass();
                
                if (testAudioContext.state === 'suspended') {
                    await testAudioContext.resume();
                }

                const oscillator = testAudioContext.createOscillator();
                const gainNode = testAudioContext.createGain();
                
                oscillator.frequency.setValueAtTime(800, testAudioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, testAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, testAudioContext.currentTime + 0.3);
                
                oscillator.connect(gainNode);
                gainNode.connect(testAudioContext.destination);
                
                oscillator.start();
                oscillator.stop(testAudioContext.currentTime + 0.3);

                statusEl.textContent = '‚úÖ WebAudio test passed';
                statusEl.className = 'status success';
                updateResult('webAudio', currentBrowser, true);
                log('WebAudio speaker test passed');

            } catch (error) {
                statusEl.textContent = `‚ùå WebAudio failed: ${error.message}`;
                statusEl.className = 'status error';
                updateResult('webAudio', currentBrowser, false);
                log(`WebAudio speaker test failed: ${error.message}`, 'error');
            }
        }

        // HTML5 Audio test
        function testHTML5Audio() {
            const statusEl = document.getElementById('speakerStatus');
            statusEl.textContent = 'Testing HTML5 Audio...';
            statusEl.className = 'status info';

            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.volume = 0.3;
                
                audio.oncanplaythrough = () => {
                    audio.play().then(() => {
                        statusEl.textContent = '‚úÖ HTML5 Audio test passed';
                        statusEl.className = 'status success';
                        log('HTML5 Audio test passed');
                    }).catch(error => {
                        statusEl.textContent = `‚ùå HTML5 playback failed: ${error.message}`;
                        statusEl.className = 'status error';
                        log(`HTML5 Audio playback failed: ${error.message}`, 'error');
                    });
                };

            } catch (error) {
                statusEl.textContent = `‚ùå HTML5 Audio failed: ${error.message}`;
                statusEl.className = 'status error';
                log(`HTML5 Audio test failed: ${error.message}`, 'error');
            }
        }

        // TTS simulation test
        async function testTTSSimulation() {
            const statusEl = document.getElementById('speakerStatus');
            statusEl.textContent = 'Testing TTS simulation...';
            statusEl.className = 'status info';

            try {
                if (!testAudioContext) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    testAudioContext = new AudioContextClass();
                }

                if (testAudioContext.state === 'suspended') {
                    await testAudioContext.resume();
                }

                // Simulate TTS PCM data
                const sampleRate = 16000;
                const duration = 1;
                const samples = sampleRate * duration;
                const pcmData = new Int16Array(samples);

                // Generate test tone
                for (let i = 0; i < samples; i++) {
                    pcmData[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 16384;
                }

                // Convert to Float32 and upsample (like real TTS)
                const targetSampleRate = testAudioContext.sampleRate;
                const upsampleRatio = Math.round(targetSampleRate / sampleRate);
                const upsampled = new Float32Array(samples * upsampleRatio);

                for (let i = 0, j = 0; i < samples; i++) {
                    const value = pcmData[i] / 32768;
                    for (let k = 0; k < upsampleRatio; k++) {
                        upsampled[j++] = value;
                    }
                }

                // Create and play buffer
                const buffer = testAudioContext.createBuffer(1, upsampled.length, targetSampleRate);
                buffer.copyToChannel(upsampled, 0);

                const source = testAudioContext.createBufferSource();
                source.buffer = buffer;
                source.connect(testAudioContext.destination);
                source.start();

                statusEl.textContent = '‚úÖ TTS simulation passed';
                statusEl.className = 'status success';
                updateResult('tts', currentBrowser, true);
                log('TTS simulation test passed');

            } catch (error) {
                statusEl.textContent = `‚ùå TTS simulation failed: ${error.message}`;
                statusEl.className = 'status error';
                updateResult('tts', currentBrowser, false);
                log(`TTS simulation failed: ${error.message}`, 'error');
            }
        }

        // Microphone access test
        async function testMicrophoneAccess() {
            const statusEl = document.getElementById('micStatus');
            statusEl.textContent = 'Testing microphone access...';
            statusEl.className = 'status info';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                statusEl.textContent = '‚úÖ Microphone access granted';
                statusEl.className = 'status success';
                updateResult('mic', currentBrowser, true);
                log('Microphone access test passed');

                // Clean up
                stream.getTracks().forEach(track => track.stop());

            } catch (error) {
                statusEl.textContent = `‚ùå Microphone access failed: ${error.message}`;
                statusEl.className = 'status error';
                updateResult('mic', currentBrowser, false);
                log(`Microphone access failed: ${error.message}`, 'error');
            }
        }

        // Run all tests
        async function runAllTests() {
            log('Starting comprehensive test suite...');
            
            await testWebAudioSpeaker();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testHTML5Audio();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testTTSSimulation();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testMicrophoneAccess();
            
            log('All tests completed');
        }

        // Export results
        function exportResults() {
            const results = {
                browser: currentBrowser,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                results: testResults
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audio-test-results-${currentBrowser}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize
        window.addEventListener('load', () => {
            detectBrowser();
            log('Cross-browser audio test tool loaded');
        });
    </script>
</body>
</html>