<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hard Beep Test - Isolated Audio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .test-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .hard-beep-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin: 20px;
        }
        .hard-beep-btn:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.info { background: #d1ecf1; color: #0c5460; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="test-card">
        <h1>üîä Hard Beep Test</h1>
        <p>This test creates a brand-new AudioContext and plays audio directly to the default output device.</p>
        <p><strong>If this doesn't work, the issue is browser/OS level, not your app.</strong></p>
        
        <button id="hardBeep" class="hard-beep-btn">üîä Test Speakers (Hard)</button>
        
        <div id="status" class="status info">
            Click the button above to test audio output
        </div>
        
        <div class="log" id="log"></div>
        
        <h3>What to Check:</h3>
        <ul style="text-align: left;">
            <li>‚úÖ <strong>Speaker icon appears</strong> in browser tab</li>
            <li>‚úÖ <strong>Audible beep</strong> plays for 200ms</li>
            <li>‚úÖ <strong>Console shows "running"</strong> AudioContext state</li>
            <li>‚ùå <strong>If silent:</strong> Check Edge autoplay settings</li>
            <li>‚ùå <strong>If no icon:</strong> AudioContext not properly resumed</li>
        </ul>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const entry = `[${timestamp}] ${message}\n`;
            logEl.textContent += entry;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`üîç ${message}`);
        }

        function setStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        document.getElementById('hardBeep').onclick = async () => {
            log('=== HARD BEEP TEST STARTING ===');
            setStatus('Testing audio output...', 'info');
            
            try {
                // Brand-new context for a clean test
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) {
                    throw new Error('AudioContext not supported');
                }
                
                const ctx = new AudioContextClass({ latencyHint: 'interactive' });
                log(`AudioContext created: state=${ctx.state}, sampleRate=${ctx.sampleRate}`);
                
                // CRITICAL: Resume in user gesture call stack
                log('Before resume: ' + ctx.state);
                try { 
                    await ctx.resume(); 
                    log('After resume: ' + ctx.state);
                } catch (e) { 
                    log('Resume failed: ' + e.message);
                    throw e;
                }
                
                if (ctx.state !== 'running') {
                    throw new Error(`AudioContext state is ${ctx.state}, expected 'running'`);
                }
                
                // Sine beep ‚Üí Gain ‚Üí destination
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                gain.gain.value = 0.2;
                osc.type = 'sine';
                osc.frequency.value = 880;
                
                log('Connecting audio graph: oscillator ‚Üí gain ‚Üí destination');
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                const startTime = Math.max(ctx.currentTime + 0.02, 0);
                log(`Starting oscillator at time: ${startTime}`);
                osc.start(startTime);
                osc.stop(startTime + 0.2);
                
                osc.onended = () => {
                    log('Beep ended. Final context state: ' + ctx.state);
                    log('=== HARD BEEP TEST COMPLETED ===');
                    
                    // Keep context alive briefly so the tab speaker icon shows
                    setTimeout(() => {
                        ctx.close();
                        log('AudioContext closed');
                    }, 400);
                };
                
                setStatus('‚úÖ Beep played! Check for speaker icon in browser tab.', 'success');
                log('SUCCESS: Audio should be playing now');
                
            } catch (error) {
                log('ERROR: ' + error.message);
                setStatus('‚ùå Audio test failed: ' + error.message, 'error');
                
                // Additional diagnostics
                log('Browser info: ' + navigator.userAgent);
                log('Secure context: ' + window.isSecureContext);
                log('Protocol: ' + window.location.protocol);
            }
        };

        // Initial browser check
        window.addEventListener('load', () => {
            log('Hard beep test loaded');
            log('Browser: ' + navigator.userAgent);
            log('AudioContext support: ' + !!(window.AudioContext || window.webkitAudioContext));
            log('Secure context: ' + window.isSecureContext);
            log('Ready for testing');
        });
    </script>
</body>
</html>