<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edge Audio Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background: #005a9e;
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .debug-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .meter {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722);
            width: 0%;
            transition: width 0.1s;
        }
        .browser-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üîß Edge Audio Debug Tool</h1>

    <div class="browser-info">
        <h3>Browser Information</h3>
        <div id="browserInfo">Loading...</div>
    </div>

    <div class="test-section">
        <h3>üîä Speaker Tests</h3>
        <button class="test-button" onclick="testSpeakerWebAudio()">Test WebAudio Speaker</button>
        <button class="test-button" onclick="testSpeakerHTML5()">Test HTML5 Audio</button>
        <button class="test-button" onclick="testSpeakerBeep()">Test System Beep</button>
        <div id="speakerStatus" class="status info">Click a button to test speaker output</div>
    </div>

    <div class="test-section">
        <h3>üé§ Microphone Tests</h3>
        <button class="test-button" onclick="testMicrophone()">Test Microphone Access</button>
        <button class="test-button" onclick="stopMicTest()" disabled id="stopMicBtn">Stop Test</button>
        <div class="meter" id="micMeter" style="display: none;">
            <div class="meter-fill" id="micMeterFill"></div>
        </div>
        <div id="micStatus" class="status info">Click to test microphone access</div>
    </div>

    <div class="test-section">
        <h3>üîÑ TTS Response Test</h3>
        <button class="test-button" onclick="testTTSResponse()">Test TTS Audio Response</button>
        <div id="ttsStatus" class="status info">Click to test TTS audio playback</div>
    </div>

    <div class="test-section">
        <h3>üìä Debug Log</h3>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
        <div id="debugLog" class="debug-log"></div>
    </div>

    <script>
        let micStream = null;
        let micTestRAF = null;
        let testAudioContext = null;

        // Debug logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('debugLog');
            const entry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logEl.textContent += entry;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`üîç ${entry.trim()}`);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        // Browser detection and info
        function detectBrowser() {
            const ua = navigator.userAgent;
            const info = {
                userAgent: ua,
                isEdge: /Edg/.test(ua),
                isChrome: /Chrome/.test(ua) && !/Edg/.test(ua),
                isFirefox: /Firefox/.test(ua),
                isSafari: /Safari/.test(ua) && !/Chrome/.test(ua),
                hasAudioContext: !!(window.AudioContext || window.webkitAudioContext),
                hasGetUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                isSecureContext: window.isSecureContext,
                protocol: window.location.protocol
            };

            log(`Browser detected: ${JSON.stringify(info, null, 2)}`);

            const browserInfoEl = document.getElementById('browserInfo');
            browserInfoEl.innerHTML = `
                <strong>Browser:</strong> ${info.isEdge ? 'Microsoft Edge' : info.isChrome ? 'Chrome' : info.isFirefox ? 'Firefox' : info.isSafari ? 'Safari' : 'Unknown'}<br>
                <strong>AudioContext:</strong> ${info.hasAudioContext ? '‚úÖ Supported' : '‚ùå Not supported'}<br>
                <strong>getUserMedia:</strong> ${info.hasGetUserMedia ? '‚úÖ Supported' : '‚ùå Not supported'}<br>
                <strong>Secure Context:</strong> ${info.isSecureContext ? '‚úÖ Yes' : '‚ùå No'}<br>
                <strong>Protocol:</strong> ${info.protocol}
            `;

            return info;
        }

        // CRITICAL: WebAudio speaker test with proper Edge/Chrome unlock
        async function testSpeakerWebAudio() {
            const statusEl = document.getElementById('speakerStatus');
            statusEl.textContent = 'Testing WebAudio speaker (unlocking audio)...';
            statusEl.className = 'status info';

            try {
                log('Starting WebAudio speaker test with audio unlock');

                // CRITICAL: Create AudioContext in user gesture call stack
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) {
                    throw new Error('AudioContext not supported');
                }

                testAudioContext = new AudioContextClass({
                    latencyHint: 'interactive'
                });
                log(`AudioContext created: state=${testAudioContext.state}, sampleRate=${testAudioContext.sampleRate}`);

                // CRITICAL: Resume context (must be in user gesture call stack)
                if (testAudioContext.state === 'suspended') {
                    log('Resuming AudioContext (user gesture)...');
                    await testAudioContext.resume();
                    log(`AudioContext resumed, new state: ${testAudioContext.state}`);
                }

                // Verify context is running
                if (testAudioContext.state !== 'running') {
                    throw new Error(`AudioContext state is ${testAudioContext.state}, expected 'running'`);
                }

                // Create oscillator for beep (same pattern as TTS)
                const oscillator = testAudioContext.createOscillator();
                const gainNode = testAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(testAudioContext.destination);

                // Configure beep
                oscillator.frequency.setValueAtTime(800, testAudioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, testAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, testAudioContext.currentTime + 0.3);

                log(`Starting oscillator at ${testAudioContext.currentTime}`);
                oscillator.start(testAudioContext.currentTime);
                oscillator.stop(testAudioContext.currentTime + 0.3);

                statusEl.textContent = '‚úÖ WebAudio test completed - Did you hear a beep? Check for speaker icon!';
                statusEl.className = 'status success';
                updateResult('webAudio', currentBrowser, true);
                log('WebAudio speaker test completed successfully - audio unlocked!');

                // Clean up after delay
                setTimeout(() => {
                    if (testAudioContext) {
                        testAudioContext.close();
                        testAudioContext = null;
                    }
                }, 1000);

            } catch (error) {
                log(`WebAudio speaker test failed: ${error.message}`, 'error');
                statusEl.textContent = `‚ùå WebAudio test failed: ${error.message}`;
                statusEl.className = 'status error';
                updateResult('webAudio', currentBrowser, false);

                // Try fallback
                log('Attempting HTML5 Audio fallback');
                testSpeakerHTML5();
            }
        }

        // Speaker test using HTML5 Audio
        function testSpeakerHTML5() {
            const statusEl = document.getElementById('speakerStatus');
            statusEl.textContent = 'Testing HTML5 Audio speaker...';
            statusEl.className = 'status info';

            try {
                log('Starting HTML5 Audio speaker test');

                // Create audio element with data URL beep
                const audio = new Audio();
                const beepDataUrl = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT';

                audio.src = beepDataUrl;
                audio.volume = 0.3;

                audio.oncanplaythrough = () => {
                    log('HTML5 Audio can play through');
                    audio.play().then(() => {
                        log('HTML5 Audio playback started successfully');
                        statusEl.textContent = '‚úÖ HTML5 Audio test completed - Did you hear a beep?';
                        statusEl.className = 'status success';
                    }).catch(error => {
                        log(`HTML5 Audio playback failed: ${error.message}`, 'error');
                        statusEl.textContent = `‚ùå HTML5 Audio playback failed: ${error.message}`;
                        statusEl.className = 'status error';
                    });
                };

                audio.onerror = (error) => {
                    log(`HTML5 Audio error: ${error}`, 'error');
                    statusEl.textContent = `‚ùå HTML5 Audio error: ${error}`;
                    statusEl.className = 'status error';
                };

            } catch (error) {
                log(`HTML5 Audio speaker test failed: ${error.message}`, 'error');
                statusEl.textContent = `‚ùå HTML5 Audio test failed: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // System beep test
        function testSpeakerBeep() {
            const statusEl = document.getElementById('speakerStatus');
            log('Testing system beep');

            try {
                // Try to trigger system beep (limited browser support)
                console.log('\x07'); // Bell character
                statusEl.textContent = 'üîî System beep attempted - Check console and system volume';
                statusEl.className = 'status info';
                log('System beep character sent to console');
            } catch (error) {
                log(`System beep failed: ${error.message}`, 'error');
                statusEl.textContent = `‚ùå System beep failed: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // Microphone test
        async function testMicrophone() {
            const statusEl = document.getElementById('micStatus');
            const meterEl = document.getElementById('micMeter');
            const stopBtn = document.getElementById('stopMicBtn');

            statusEl.textContent = 'Requesting microphone access...';
            statusEl.className = 'status info';

            try {
                log('Starting microphone test');

                // Request microphone access
                micStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                log(`Microphone stream obtained: ${micStream.getTracks().length} tracks`);

                // Create audio context for analysis
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                testAudioContext = new AudioContextClass();

                if (testAudioContext.state === 'suspended') {
                    await testAudioContext.resume();
                }

                // Set up audio analysis
                const source = testAudioContext.createMediaStreamSource(micStream);
                const analyser = testAudioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                // Show meter and enable stop button
                meterEl.style.display = 'block';
                stopBtn.disabled = false;

                statusEl.textContent = '‚úÖ Microphone active - Speak to see level meter';
                statusEl.className = 'status success';

                // Animation loop for level meter
                function updateMeter() {
                    if (!micStream) return;

                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                    const percentage = (average / 255) * 100;

                    document.getElementById('micMeterFill').style.width = `${percentage}%`;

                    micTestRAF = requestAnimationFrame(updateMeter);
                }

                updateMeter();
                log('Microphone test started successfully');

            } catch (error) {
                log(`Microphone test failed: ${error.message}`, 'error');
                statusEl.textContent = `‚ùå Microphone test failed: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // Stop microphone test
        function stopMicTest() {
            const statusEl = document.getElementById('micStatus');
            const meterEl = document.getElementById('micMeter');
            const stopBtn = document.getElementById('stopMicBtn');

            log('Stopping microphone test');

            if (micTestRAF) {
                cancelAnimationFrame(micTestRAF);
                micTestRAF = null;
            }

            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
                micStream = null;
            }

            if (testAudioContext) {
                testAudioContext.close();
                testAudioContext = null;
            }

            meterEl.style.display = 'none';
            stopBtn.disabled = true;
            statusEl.textContent = '‚úÖ Microphone test stopped';
            statusEl.className = 'status success';

            log('Microphone test stopped successfully');
        }

        // TTS Response test
        async function testTTSResponse() {
            const statusEl = document.getElementById('ttsStatus');
            statusEl.textContent = 'Testing TTS audio response...';
            statusEl.className = 'status info';

            try {
                log('Starting TTS response test');

                // Simulate TTS audio data (PCM format)
                const sampleRate = 22050;
                const duration = 2; // 2 seconds
                const samples = sampleRate * duration;
                const audioData = new Float32Array(samples);

                // Generate a simple tone for testing
                for (let i = 0; i < samples; i++) {
                    audioData[i] = Math.sin(2 * Math.PI * 440 * i / sampleRate) * 0.3;
                }

                log(`Generated test audio: ${samples} samples at ${sampleRate}Hz`);

                // Create AudioContext
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                testAudioContext = new AudioContextClass();

                if (testAudioContext.state === 'suspended') {
                    await testAudioContext.resume();
                    log(`AudioContext resumed for TTS test`);
                }

                // Create audio buffer
                const audioBuffer = testAudioContext.createBuffer(1, samples, sampleRate);
                audioBuffer.copyToChannel(audioData, 0);

                // Create and play audio source
                const source = testAudioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(testAudioContext.destination);

                source.onended = () => {
                    log('TTS test audio playback completed');
                    statusEl.textContent = '‚úÖ TTS test completed - Did you hear the tone?';
                    statusEl.className = 'status success';

                    // Clean up
                    setTimeout(() => {
                        if (testAudioContext) {
                            testAudioContext.close();
                            testAudioContext = null;
                        }
                    }, 500);
                };

                source.start();
                log('TTS test audio playback started');

            } catch (error) {
                log(`TTS response test failed: ${error.message}`, 'error');
                statusEl.textContent = `‚ùå TTS test failed: ${error.message}`;
                statusEl.className = 'status error';
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('Edge Audio Debug Tool loaded');
            detectBrowser();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopMicTest();
            if (testAudioContext) {
                testAudioContext.close();
            }
        });
    </script>
</body>
</html>
